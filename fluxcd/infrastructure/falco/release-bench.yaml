---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: falco
spec:
  chart:
    spec:
      chart: falco
      sourceRef:
        kind: HelmRepository
        name: falcosecurity
        namespace: flux-system
  interval: 10m
  values:
    falco:
      grpc:
        enabled: true
        threadiness: 0
      
        # gRPC unix socket with no authentication
        unixSocketPath: "unix:///var/run/falco/falco.sock"
      
        # gRPC over the network (mTLS) / required when unixSocketPath is empty
        listenPort: 5060
        privateKey: "/etc/falco/certs/server.key"
        certChain: "/etc/falco/certs/server.crt"
        rootCerts: "/etc/falco/certs/ca.crt"
      
      # gRPC output service.
      # By default it is off.
      # By enabling this all the output events will be kept in memory until you read them with a gRPC client.
      # Make sure to have a consumer for them or leave this disabled.
      grpcOutput:
        enabled: true
      
      # A throttling mechanism implemented as a token bucket limits the
      # rate of Falco notifications. This throttling is controlled by the following configuration
      # options:
      #  - rate: the number of tokens (i.e. right to send a notification)
      #    gained per second. Defaults to 1.
      #  - max_burst: the maximum number of tokens outstanding. Defaults to 1000.
      #
      # With these defaults, Falco could send up to 1000 notifications after
      # an initial quiet period, and then up to 1 notification per second
      # afterward. It would gain the full burst back after 1000 seconds of
      # no activity.
      outputs:
        rate: "1000000000"
        maxBurst: "1000000000"
    falcosidekick:
      enabled: true
      webui:
        enabled: true
    ebpf:
      enabled: true
    leastPrivileged:
      enabled: false # The CAP_BPF capability is only added in linux kernel 5.8. Azure is using 5.4. For now we need to run ebpf in privileged mode.
    
  postRenderers:
  - kustomize:
      patchesJson6902:
      - target:
          kind: DaemonSet
          name: falco
        patch:
        - op: add
          path: /spec/template/spec/containers/0/args/1
          value: -s
        - op: add
          path: /spec/template/spec/containers/0/args/2
          value: /var/log/falco.txt
        - op: add
          path: /spec/template/spec/containers/0/args/3
          value: --stats-interval
        - op: add
          path: /spec/template/spec/containers/0/args/4
          value: "1000"
